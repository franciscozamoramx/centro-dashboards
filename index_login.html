<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence - Big Bola</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/PJSBFV7L/panel.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a3a8f 0%, #152c6e 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            max-width: 250px;
            margin: 0 auto 20px;
            display: block;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        p {
            font-size: 18px;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(to bottom, #FFD700, #FF8C00);
            color: #152c6e;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, #FFE600, #FF9E00);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .user-info {
            margin-top: 15px;
            font-size: 14px;
            color: #FFD700;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status-success {
            background: rgba(0, 255, 0, 0.2);
            color: #90EE90;
        }
        
        .status-error {
            background: rgba(255, 0, 0, 0.2);
            color: #FFB6C1;
        }
        
        .status-loading {
            background: rgba(255, 255, 0, 0.2);
            color: #FFD700;
        }

        @media (max-width: 600px) {
            .login-container {
                padding: 25px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            p {
                font-size: 16px;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor de login -->
    <div class="login-container" id="loginContainer">
        <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="logo">
        <h1>Centro de Business Intelligence</h1>
        <p>Ingresa con tu correo corporativo</p>
        
        <div class="login-form">
            <div class="form-group">
                <label for="email">Correo electr√≥nico:</label>
                <input type="email" id="email" placeholder="usuario@bigbola.com" required>
            </div>
            <button class="btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Ingresar al Centro de BI
            </button>
        </div>
        
        <div class="status-message" id="statusMessage" style="display: none;"></div>
        
        <div class="user-info" id="userInfo" style="display: none;">
            <p>Bienvenido: <span id="userEmail"></span></p>
            <p>Dashboards disponibles: <span id="dashboardsCount"></span></p>
        </div>
    </div>

    <script>
        // Mapeo de dashboards a URLs
        const dashboardUrls = {
            "principal": "https://app.powerbi.com/reportEmbed?reportId=9bd044c3-981b-4a9a-914a-b7bf130dae59&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "adt": "https://app.powerbi.com/reportEmbed?reportId=1149b379-aad5-4876-bfe6-c325dc89308f&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "auditoria": "https://app.powerbi.com/reportEmbed?reportId=a78289b5-2543-4104-aff7-96e30ef79b58&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "bigplayers": "https://app.powerbi.com/reportEmbed?reportId=ff7ca313-9e8f-4513-9bcd-df9182f2464a&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "desempeno": "https://app.powerbi.com/reportEmbed?reportId=28c07103-a77e-42f4-a9ca-7d9345b48131&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "inventario": "https://app.powerbi.com/reportEmbed?reportId=4fe689c1-3fa7-4632-8367-4b7a7abc492c&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "promociones": "https://app.powerbi.com/reportEmbed?reportId=7253b2c9-12b1-4a8a-b555-2fef1d62e1b3&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "proyectos": "https://app.powerbi.com/reportEmbed?reportId=c2e5834e-4e3d-418c-a9dc-43e33d79a62e&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "rtp": "https://app.powerbi.com/reportEmbed?reportId=01ac285e-618f-43de-be89-d62b1a46374c&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "diccionario": "https://app.powerbi.com/reportEmbed?reportId=95918a25-c06b-411a-a346-f462b03e557b&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c"
        };

        // Mapeo de nombres de dashboards
        const dashboardNames = {
            "principal": "Principal",
            "adt": "ADT",
            "auditoria": "Auditor√≠a de Salas",
            "bigplayers": "Big Player's",
            "desempeno": "Desempe√±o de M√°quinas",
            "inventario": "Inventario TI",
            "promociones": "Promociones",
            "proyectos": "Proyectos BI",
            "rtp": "RTP",
            "diccionario": "Diccionario KPI's"
        };

        // Mapeo de √≠conos para dashboards
        const dashboardIcons = {
            "principal": "fas fa-house",
            "adt": "fas fa-chart-line",
            "auditoria": "fas fa-search",
            "bigplayers": "fas fa-gem",
            "desempeno": "fas fa-tachometer-alt",
            "inventario": "fas fa-desktop",
            "promociones": "fas fa-gift",
            "proyectos": "fas fa-project-diagram",
            "rtp": "fas fa-coins",
            "diccionario": "fas fa-book"
        };

        // ==================== CONFIGURACI√ìN DE LOGGING ====================
        const LOGGING_ENABLED = true;
        const LOGS_URL = 'https://franciscozamoramx.github.io/centro-dashboards/logs/update-log.php';
        let currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Permisos por defecto
        const defaultPermissions = {
            "users": {
                "francisco.zamora@bigbola.com": {
                    "dashboards": ["principal", "adt", "bigplayers", "desempeno", "proyectos", "rtp", "diccionario"]
                },
                "gerente@bigbola.com": {
                    "dashboards": ["principal", "adt"]
                },
                "demo@bigbola.com": {
                    "dashboards": ["principal", "adt", "auditoria", "bigplayers", "desempeno"]
                }
            }
        };

        let permissionsData = null;
        let currentUser = null;
        let currentUserPermissions = [];

        // Detectar si es dispositivo m√≥vil/tableta
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || 
                   (navigator.userAgent.indexOf('IEMobile') !== -1) ||
                   (window.innerWidth <= 1024);
        }

        // ==================== FUNCIONES DE LOGGING ====================

        // Funci√≥n principal para registrar accesos
        async function logAccess(action, dashboardKey = null) {
            if (!currentUser || !LOGGING_ENABLED) return;
            
            try {
                const logData = {
                    // Identificaci√≥n
                    sessionId: currentSessionId,
                    timestamp: new Date().toISOString(),
                    
                    // Informaci√≥n del usuario
                    user: currentUser,
                    
                    // Acci√≥n realizada
                    action: action,
                    
                    // Informaci√≥n del dashboard (si aplica)
                    dashboard: dashboardKey,
                    dashboardName: dashboardKey ? dashboardNames[dashboardKey] : null,
                    
                    // Informaci√≥n del dispositivo
                    deviceType: isMobileDevice() ? 'mobile' : 'desktop',
                    screen: `${window.screen.width}x${window.screen.height}`,
                    viewport: `${window.innerWidth}x${window.innerHeight}`,
                    userAgent: navigator.userAgent.substring(0, 150),
                    language: navigator.language,
                    platform: navigator.platform,
                    
                    // Informaci√≥n de navegaci√≥n
                    url: window.location.href,
                    referrer: document.referrer || 'direct'
                };
                
                // Enviar log de forma as√≠ncrona (no bloqueante)
                sendLogToServer(logData);
                
                // Tambi√©n guardar localmente como respaldo
                saveLogLocally(logData);
                
            } catch (error) {
                console.error('Error en logAccess:', error);
            }
        }

        // Enviar log al servidor (GitHub Pages)
        async function sendLogToServer(logData) {
            try {
                // Usar FormData para evitar problemas CORS
                const formData = new FormData();
                formData.append('log', JSON.stringify(logData));
                
                // Enviar con fetch (no-cors para evitar problemas)
                await fetch(LOGS_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors' // Importante: evita errores CORS
                });
                
                console.log('‚úÖ Log enviado:', logData.action, logData.user);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo enviar log, guardando localmente:', error);
                savePendingLog(logData);
            }
        }

        // Guardar log localmente como respaldo
        function saveLogLocally(logData) {
            try {
                const key = 'bi_local_logs';
                let logs = JSON.parse(localStorage.getItem(key) || '[]');
                
                logs.push({
                    ...logData,
                    storedAt: new Date().toISOString()
                });
                
                // Mantener solo √∫ltimos 100 logs locales
                if (logs.length > 100) {
                    logs = logs.slice(-100);
                }
                
                localStorage.setItem(key, JSON.stringify(logs));
                
            } catch (error) {
                console.warn('Error guardando log local:', error);
            }
        }

        // Guardar logs pendientes (cuando falla el env√≠o)
        function savePendingLog(logData) {
            try {
                const key = 'bi_pending_logs';
                let pending = JSON.parse(localStorage.getItem(key) || '[]');
                
                pending.push({
                    ...logData,
                    retryCount: 0,
                    lastTry: new Date().toISOString()
                });
                
                // Mantener solo √∫ltimos 50 pendientes
                if (pending.length > 50) {
                    pending = pending.slice(-50);
                }
                
                localStorage.setItem(key, JSON.stringify(pending));
                
            } catch (error) {
                console.error('Error guardando log pendiente:', error);
            }
        }

        // Reintentar enviar logs pendientes
        function retryPendingLogs() {
            try {
                const pending = JSON.parse(localStorage.getItem('bi_pending_logs') || '[]');
                if (pending.length === 0) return;
                
                console.log(`üîÑ Reintentando ${pending.length} logs pendientes...`);
                
                pending.forEach(log => {
                    if (log.retryCount < 3) { // M√°ximo 3 intentos
                        setTimeout(() => sendLogToServer(log), 1000);
                    }
                });
                
                // Limpiar despu√©s de intentar
                localStorage.removeItem('bi_pending_logs');
                
            } catch (error) {
                console.error('Error reintentando logs:', error);
            }
        }

        // Funci√≥n para cerrar sesi√≥n con logging
        function logoutUser() {
            // üîê LOGGING: Registrar cierre de sesi√≥n
            if (currentUser) {
                const logoutData = {
                    sessionId: currentSessionId,
                    timestamp: new Date().toISOString(),
                    user: currentUser,
                    action: 'logout',
                    deviceType: isMobileDevice() ? 'mobile' : 'desktop'
                };
                saveLogLocally(logoutData);
                
                // Intentar enviar al servidor
                sendLogToServer(logoutData);
            }
            
            // Cerrar la ventana o recargar para login
            if (window.opener) {
                window.close();
            } else {
                window.location.reload();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // üîí BLOQUEO DE SEGURIDAD EN LOGIN
            function blockRightClick(e) {
                e.preventDefault();
                showContextMenuMessage();
                return false;
            }
            
            function blockFunctionKeys(e) {
                // Teclas F1-F12
                if (e.keyCode >= 112 && e.keyCode <= 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+Shift+I (DevTools)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    return false;
                }
                
                // F12 (DevTools)
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+U (Ver c√≥digo fuente)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+Shift+C (Inspector)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+R (Recargar)
                if (e.ctrlKey && e.keyCode === 82) {
                    e.preventDefault();
                    return false;
                }
            }
            
            function showContextMenuMessage() {
                let message = document.getElementById('contextMenuMessageLogin');
                if (!message) {
                    message = document.createElement('div');
                    message.id = 'contextMenuMessageLogin';
                    message.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        padding: 10px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                        display: none;
                        animation: fadeInOut 3s ease-in-out;
                    `;
                    document.body.appendChild(message);
                    
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes fadeInOut {
                            0% { opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                message.textContent = 'Men√∫ contextual deshabilitado';
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            }
            
            function applyLoginSecurity() {
                document.addEventListener('contextmenu', blockRightClick);
                document.addEventListener('keydown', blockFunctionKeys);
            }
            
            // Aplicar seguridad inmediatamente
            applyLoginSecurity();
            
            // C√ìDIGO EXISTENTE
            showStatus('Cargando permisos...', 'loading');
            loadPermissions();
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.addEventListener('click', handleLogin);
            
            const emailInput = document.getElementById('email');
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Reintentar logs pendientes cada 30 segundos
            setInterval(retryPendingLogs, 30000);
            
            // Tambi√©n al cargar la p√°gina
            setTimeout(retryPendingLogs, 5000);
        });

        // Funci√≥n para cargar los permisos desde el JSON
        async function loadPermissions() {
            try {
                // Usar la ruta absoluta de GitHub Pages
                const jsonUrl = 'https://franciscozamoramx.github.io/centro-dashboards/PERMISSION_FILES_BI/permissions.json';
                
                console.log('Cargando permisos desde:', jsonUrl);
                
                const response = await fetch(jsonUrl + '?t=' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Respuesta recibida:', text);
                
                if (!text.trim()) {
                    throw new Error('El archivo JSON est√° vac√≠o');
                }
                
                const data = JSON.parse(text);
                
                if (!data.users) {
                    throw new Error('Estructura de JSON inv√°lida: falta propiedad "users"');
                }
                
                permissionsData = data;
                console.log('Permisos cargados correctamente desde GitHub Pages', permissionsData);
                showStatus('Permisos cargados correctamente', 'success');
                setTimeout(hideStatus, 2000);
                
            } catch (error) {
                console.error('Error al cargar permisos:', error);
                
                let errorMessage = 'Error cargando permisos: ' + error.message;
                
                permissionsData = defaultPermissions;
                showStatus('Usando permisos por defecto - ' + errorMessage, 'error');
                console.log('Permisos por defecto cargados:', permissionsData);
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            } else if (type === 'loading') {
                statusElement.classList.add('status-loading');
            }
            
            statusElement.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        function handleLogin() {
            const email = document.getElementById('email').value.trim().toLowerCase();
            
            if (!email) {
                showStatus('Por favor ingresa tu correo electr√≥nico', 'error');
                return;
            }
            
            if (!permissionsData) {
                showStatus('Error: Los permisos no se han cargado correctamente. Intenta nuevamente.', 'error');
                return;
            }
            
            if (permissionsData.users && permissionsData.users[email]) {
                currentUser = email;
                currentUserPermissions = permissionsData.users[email].dashboards || [];
                
                // üîê LOGGING: Registrar inicio de sesi√≥n
                logAccess('login');
                
                // Generar nueva sesi√≥n para este usuario
                currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Mostrar informaci√≥n breve
                document.getElementById('userEmail').textContent = email;
                document.getElementById('dashboardsCount').textContent = currentUserPermissions.length;
                document.getElementById('userInfo').style.display = 'block';
                
                showStatus('Acceso concedido. Abriendo Centro de BI...', 'success');
                
                console.log('=== LOGIN EXITOSO ===');
                console.log('Usuario:', currentUser);
                console.log('Dashboards permitidos:', currentUserPermissions.length);
                console.log('Lista de dashboards:', currentUserPermissions);
                console.log('=====================');
                
                // Abrir directamente el dashboard despu√©s de breve delay
                setTimeout(() => {
                    openDashboard();
                }, 1000);
                
            } else {
                // üîê LOGGING: Registrar intento fallido de login
                const failedLoginData = {
                    sessionId: 'failed_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    user: email,
                    action: 'login_failed',
                    deviceType: isMobileDevice() ? 'mobile' : 'desktop',
                    userAgent: navigator.userAgent.substring(0, 100)
                };
                saveLogLocally(failedLoginData);
                
                showStatus('No tienes permisos para acceder al Centro de BI o el correo no est√° registrado.', 'error');
            }
        }

        // Funci√≥n para abrir el dashboard en pantalla completa
        function openDashboard() {
            // Si es m√≥vil, mostrar versi√≥n m√≥vil en la misma ventana
            if (isMobileDevice()) {
                showMobileDashboard();
                return;
            }
            
            // Para PC: abrir en nueva ventana en pantalla completa
            const dashboardHTML = generateDashboardHTML();
            
            const dashboardWindow = window.open('', '_blank', 'width=' + screen.width + ',height=' + screen.height + ',left=0,top=0,fullscreen=yes');
            
            if (dashboardWindow) {
                dashboardWindow.document.write(dashboardHTML);
                dashboardWindow.document.close();
                dashboardWindow.focus();
                
                // Cerrar la ventana de login despu√©s de abrir el dashboard
                setTimeout(() => {
                    window.close();
                }, 1000);
                
            } else {
                // Si falla la ventana emergente, mostrar en la misma ventana
                showStatus('Popup bloqueado. Mostrando en esta ventana...', 'error');
                setTimeout(() => {
                    showMobileDashboard();
                }, 2000);
            }
        }

        // Funci√≥n para mostrar dashboard m√≥vil en la misma ventana
        function showMobileDashboard() {
            const mobileHTML = generateMobileDashboardHTML();
            document.body.innerHTML = mobileHTML;
            initMobileDashboardFunctionality();
        }

        // Funci√≥n para generar el HTML del dashboard m√≥vil
        function generateMobileDashboardHTML() {
            let menuItemsHTML = '';
            
            // Dashboard principal
            if (currentUserPermissions.includes('principal')) {
                menuItemsHTML += `
                    <button class="mobile-menu-item active" data-src="${dashboardUrls.principal}">
                        <i class="${dashboardIcons.principal}"></i> ${dashboardNames.principal}
                    </button>
                `;
            }
            
            // Otros dashboards
            const otherDashboards = currentUserPermissions.filter(d => d !== 'principal' && d !== 'diccionario');
            if (otherDashboards.length > 0) {
                menuItemsHTML += `<div class="mobile-menu-section">Dashboards</div>`;
                
                otherDashboards.forEach(dashboard => {
                    if (dashboardUrls[dashboard]) {
                        menuItemsHTML += `
                            <button class="mobile-menu-item" data-src="${dashboardUrls[dashboard]}">
                                <i class="${dashboardIcons[dashboard]}"></i> ${dashboardNames[dashboard]}
                            </button>
                        `;
                    }
                });
            }
            
            // Herramientas
            menuItemsHTML += `<div class="mobile-menu-section">Herramientas</div>`;
            
            // Diccionario KPI's
            if (currentUserPermissions.includes('diccionario')) {
                menuItemsHTML += `
                    <button class="mobile-menu-item" data-src="${dashboardUrls.diccionario}">
                        <i class="${dashboardIcons.diccionario}"></i> ${dashboardNames.diccionario}
                    </button>
                `;
            }
            
            // Bot√≥n de ayuda
            menuItemsHTML += `
                <button class="mobile-menu-item" id="mobileWhatsappBtn">
                    <i class="fab fa-whatsapp"></i> Ayuda
                </button>
            `;
            
            // Determinar dashboard inicial
            const firstDashboard = currentUserPermissions.includes('principal') ? 'principal' : currentUserPermissions[0];
            const initialUrl = dashboardUrls[firstDashboard] || dashboardUrls.principal;
            
            return `
                <div class="mobile-dashboard-container">
                    <button class="mobile-floating-toggle" id="mobileToggleBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="mobile-sidebar-overlay" id="mobileOverlay"></div>
                    
                    <div class="mobile-sidebar" id="mobileSidebar">
                        <div class="mobile-sidebar-header">
                            <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="mobile-sidebar-logo">
                            <div class="mobile-sidebar-title">
                                <div>Centro de</div>
                                <div>Business Intelligence</div>
                            </div>
                            <div class="user-info" style="margin-top: 10px; font-size: 12px;">
                                Usuario: ${currentUser}
                            </div>
                        </div>
                        ${menuItemsHTML}
                        <div class="mobile-sidebar-footer">
                            <button class="mobile-exit-btn" id="mobileExitBtn">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                    
                    <div class="mobile-iframe-container" id="mobileIframeContainer">
                        <iframe class="mobile-iframe" id="mobileIframe" src="${initialUrl}"></iframe>
                    </div>
                </div>

                <style>
                    .mobile-dashboard-container {
                        width: 100vw;
                        height: 100vh;
                        background: #f5f5f5;
                        position: fixed;
                        top: 0;
                        left: 0;
                        z-index: 1000;
                    }
                    
                    .mobile-floating-toggle {
                        position: fixed;
                        top: 20px;
                        left: 20px;
                        width: 50px;
                        height: 50px;
                        background: rgba(26, 58, 143, 0.8);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        transition: all 0.3s ease;
                    }
                    
                    .mobile-sidebar {
                        position: fixed;
                        top: 0;
                        left: -280px;
                        width: 280px;
                        height: 100vh;
                        background: #152c6e;
                        z-index: 1002;
                        transition: left 0.3s ease;
                        overflow-y: auto;
                        padding: 20px;
                        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .mobile-sidebar.active { left: 0; }
                    
                    .mobile-sidebar-overlay {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 1001;
                    }
                    
                    .mobile-sidebar-overlay.active { display: block; }
                    
                    .mobile-sidebar-header {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 20px 0;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        margin-bottom: 20px;
                    }
                    
                    .mobile-sidebar-logo {
                        height: 60px;
                        width: auto;
                        margin-bottom: 15px;
                    }
                    
                    .mobile-sidebar-title {
                        font-size: 18px;
                        font-weight: bold;
                        color: white;
                        text-align: center;
                        line-height: 1.2;
                    }
                    
                    .mobile-menu-section {
                        color: #FFD700;
                        font-weight: bold;
                        margin: 20px 0 10px;
                        padding-bottom: 5px;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        font-size: 16px;
                    }
                    
                    .mobile-menu-item {
                        display: block;
                        width: 100%;
                        padding: 12px 15px;
                        margin-bottom: 8px;
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        text-align: left;
                        cursor: pointer;
                        transition: background 0.3s;
                        font-size: 15px;
                    }
                    
                    .mobile-menu-item:hover { background: rgba(255,255,255,0.2); }
                    .mobile-menu-item.active {
                        background: rgba(255,215,0,0.3);
                        border-left: 3px solid #FFD700;
                    }
                    
                    .mobile-menu-item i {
                        margin-right: 10px;
                        width: 20px;
                        text-align: center;
                    }
                    
                    .mobile-sidebar-footer {
                        margin-top: auto;
                        padding-top: 20px;
                        border-top: 1px solid rgba(255,255,255,0.2);
                    }
                    
                    .mobile-exit-btn {
                        display: block;
                        width: 100%;
                        padding: 12px 15px;
                        background: rgba(255, 0, 0, 0.2);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 15px;
                        transition: background 0.3s;
                        text-align: center;
                    }
                    
                    .mobile-exit-btn:hover { background: rgba(255, 0, 0, 0.3); }
                    
                    .mobile-iframe-container {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: white;
                        transition: left 0.3s ease;
                    }
                    
                    .mobile-iframe-container.sidebar-open {
                        left: 280px;
                        width: calc(100% - 280px);
                    }
                    
                    .mobile-iframe {
                        width: 100%;
                        height: 100%;
                        border: none;
                    }
                    
                    @media (max-width: 600px) {
                        .mobile-floating-toggle {
                            width: 45px;
                            height: 45px;
                            font-size: 18px;
                            top: 15px;
                            left: 15px;
                        }
                        
                        .mobile-sidebar { width: 260px; }
                        
                        .mobile-iframe-container.sidebar-open {
                            left: 260px;
                            width: calc(100% - 260px);
                        }
                    }
                </style>
            `;
        }

        // Funci√≥n para generar el HTML del dashboard para PC
        function generateDashboardHTML() {
            let menuItemsHTML = '';
            
            if (currentUserPermissions.includes('principal')) {
                menuItemsHTML += `
                    <button class="menu-item active" data-src="${dashboardUrls.principal}">
                        <i class="${dashboardIcons.principal}"></i> ${dashboardNames.principal}
                    </button>
                `;
            }
            
            const otherDashboards = currentUserPermissions.filter(d => d !== 'principal' && d !== 'diccionario');
            if (otherDashboards.length > 0) {
                menuItemsHTML += `<div class="menu-section">Dashboards</div>`;
                
                otherDashboards.forEach(dashboard => {
                    if (dashboardUrls[dashboard]) {
                        menuItemsHTML += `
                            <button class="menu-item" data-src="${dashboardUrls[dashboard]}">
                                <i class="${dashboardIcons[dashboard]}"></i> ${dashboardNames[dashboard]}
                            </button>
                        `;
                    }
                });
            }
            
            menuItemsHTML += `<div class="menu-section">Herramientas</div>`;
            
            if (currentUserPermissions.includes('diccionario')) {
                menuItemsHTML += `
                    <button class="menu-item" data-src="${dashboardUrls.diccionario}">
                        <i class="${dashboardIcons.diccionario}"></i> ${dashboardNames.diccionario}
                    </button>
                `;
            }
            
            menuItemsHTML += `
                <button class="menu-item" id="whatsappBtn">
                    <i class="fab fa-whatsapp"></i> Ayuda
                </button>
            `;
            
            let initialDashboard = dashboardUrls.principal;
            if (currentUserPermissions.includes('principal')) {
                initialDashboard = dashboardUrls.principal;
            } else if (currentUserPermissions.length > 0) {
                initialDashboard = dashboardUrls[currentUserPermissions[0]] || dashboardUrls.principal;
            }
            
            return `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Business Intelligence de Big Bola Casinos</title>
                    <link rel="icon" type="image/png" href="https://i.postimg.cc/QCN4dPG1/analisis-de-datos.png">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        }
                        
                        body {
                            background-color: #f5f5f5;
                            overflow: hidden;
                            margin: 0;
                            padding: 0;
                        }
                        
                        .container {
                            width: 100vw;
                            height: 100vh;
                            background-color: #fff;
                            display: flex;
                            flex-direction: column;
                            position: relative;
                        }
                        
                        .floating-toggle {
                            position: fixed;
                            top: 20px;
                            left: 20px;
                            width: 50px;
                            height: 50px;
                            background: rgba(26, 58, 143, 0.8);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            cursor: pointer;
                            z-index: 1001;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s ease;
                        }
                        
                        .floating-toggle:hover {
                            background: rgba(26, 58, 143, 0.9);
                            transform: scale(1.05);
                        }
                        
                        .sidebar {
                            position: fixed;
                            top: 0;
                            left: -320px;
                            width: 320px;
                            height: 100vh;
                            background: #152c6e;
                            z-index: 1002;
                            transition: left 0.3s ease;
                            overflow-y: auto;
                            padding: 20px;
                            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
                            display: flex;
                            flex-direction: column;
                        }
                        
                        .sidebar.active { left: 0; }
                        
                        .sidebar-overlay {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            z-index: 1001;
                        }
                        
                        .sidebar-overlay.active { display: block; }
                        
                        .sidebar-header {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            padding: 20px 0;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                            margin-bottom: 20px;
                        }
                        
                        .sidebar-logo {
                            height: 60px;
                            width: auto;
                            margin-bottom: 15px;
                        }
                        
                        .sidebar-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: white;
                            text-align: center;
                            line-height: 1.2;
                        }
                        
                        .user-info {
                            margin-top: 10px;
                            font-size: 12px;
                            color: #FFD700;
                            text-align: center;
                        }
                        
                        .menu-section {
                            color: #FFD700;
                            font-weight: bold;
                            margin: 20px 0 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                            font-size: 16px;
                        }
                        
                        .menu-item {
                            display: block;
                            width: 100%;
                            padding: 12px 15px;
                            margin-bottom: 8px;
                            background: rgba(255,255,255,0.1);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            text-align: left;
                            cursor: pointer;
                            transition: background 0.3s;
                            font-size: 15px;
                        }
                        
                        .menu-item:hover { background: rgba(255,255,255,0.2); }
                        .menu-item.active {
                            background: rgba(255,215,0,0.3);
                            border-left: 3px solid #FFD700;
                        }
                        
                        .menu-item i {
                            margin-right: 10px;
                            width: 20px;
                            text-align: center;
                        }
                        
                        .sidebar-footer {
                            margin-top: auto;
                            padding-top: 20px;
                            border-top: 1px solid rgba(255,255,255,0.2);
                        }
                        
                        .exit-btn {
                            display: block;
                            width: 100%;
                            padding: 12px 15px;
                            background: rgba(255, 0, 0, 0.2);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 15px;
                            transition: background 0.3s;
                            text-align: center;
                        }
                        
                        .exit-btn:hover { background: rgba(255, 0, 0, 0.3); }
                        
                        .iframe-container {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: white;
                            transition: left 0.3s ease;
                        }
                        
                        .iframe-container.sidebar-open {
                            left: 320px;
                            width: calc(100% - 320px);
                        }
                        
                        iframe {
                            width: 100%;
                            height: 100%;
                            border: none;
                        }
                        
                        /* Overlay para bloqueo de clic derecho - ELIMINADO */
                        
                        /* Estilo para el mensaje de men√∫ deshabilitado */
                        .context-menu-message {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            background: rgba(0,0,0,0.7);
                            color: white;
                            padding: 10px;
                            border-radius: 5px;
                            z-index: 10000;
                            font-size: 14px;
                            display: none;
                            animation: fadeInOut 3s ease-in-out;
                        }
                        
                        @keyframes fadeInOut {
                            0% { opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { opacity: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="context-menu-message" id="contextMenuMessage">Men√∫ contextual deshabilitado</div>
                    <div class="container">
                        <button class="floating-toggle" id="toggleBtn">
                            <i class="fas fa-bars"></i>
                        </button>
                        
                        <div class="sidebar-overlay" id="overlay"></div>
                        
                        <div class="sidebar" id="sidebar">
                            <div class="sidebar-header">
                                <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="sidebar-logo">
                                <div class="sidebar-title">
                                    <div>Centro de</div>
                                    <div>Business Intelligence</div>
                                </div>
                                <div class="user-info">
                                    Usuario: ${currentUser}
                                </div>
                            </div>
                            ${menuItemsHTML}
                            <div class="sidebar-footer">
                                <button class="exit-btn" onclick="logoutUser()">
                                    <i class="fas fa-sign-out-alt"></i> Salir
                                </button>
                            </div>
                        </div>
                        
                        <div class="iframe-container" id="iframeContainer">
                            <iframe id="dashboardFrame" src="${initialDashboard}"></iframe>
                        </div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const toggleBtn = document.getElementById('toggleBtn');
                            const sidebar = document.getElementById('sidebar');
                            const overlay = document.getElementById('overlay');
                            const iframeContainer = document.getElementById('iframeContainer');
                            const menuItems = document.querySelectorAll('.menu-item');
                            const whatsappBtn = document.getElementById('whatsappBtn');
                            const iframe = document.getElementById('dashboardFrame');
                            const contextMenuMessage = document.getElementById('contextMenuMessage');
                            
                            let isSidebarOpen = false;
                            
                            // üîí FUNCIONES DE BLOQUEO DE SEGURIDAD - SOLO PARA EL MEN√ö
                            
                            // Bloquear clic derecho SOLO en el sidebar
                            function blockRightClickOnSidebar(e) {
                                e.preventDefault();
                                showContextMenuMessage();
                                return false;
                            }
                            
                            // Mostrar mensaje de men√∫ contextual deshabilitado
                            function showContextMenuMessage() {
                                contextMenuMessage.style.display = 'block';
                                setTimeout(() => {
                                    contextMenuMessage.style.display = 'none';
                                }, 3000);
                            }
                            
                            // Aplicar bloqueos de seguridad SOLO al sidebar
                            function applySecurityBlocks() {
                                // Bloquear clic derecho SOLO en el sidebar
                                sidebar.addEventListener('contextmenu', blockRightClickOnSidebar);
                                
                                // Permitir clic derecho en el resto de la p√°gina
                                document.addEventListener('contextmenu', function(e) {
                                    // Permitir clic derecho en todo excepto en el sidebar
                                    if (!sidebar.contains(e.target)) {
                                        return true; // Permitir el comportamiento normal
                                    }
                                });
                                
                                // Bloquear clic derecho en el iframe cuando tiene el foco
                                iframe.addEventListener('load', function() {
                                    try {
                                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                                        // Permitir clic derecho dentro del iframe (Power BI)
                                        // No aplicar bloqueo aqu√≠ para permitir funcionalidad normal de Power BI
                                    } catch (e) {
                                        // Si hay error de CORS, no hacer nada - permitir comportamiento normal
                                    }
                                });
                            }
                            
                            // FUNCIONES DE LA APLICACI√ìN
                            
                            function openWhatsApp() {
                                const phoneNumber = '+524421974414';
                                const message = 'Hola, necesito ayuda en el Centro de Business Intelligence';
                                const url = 'https://wa.me/' + phoneNumber + '?text=' + encodeURIComponent(message);
                                window.open(url, '_blank');
                            }
                            
                            function toggleSidebar() {
                                isSidebarOpen = !isSidebarOpen;
                                sidebar.classList.toggle('active');
                                overlay.classList.toggle('active');
                                iframeContainer.classList.toggle('sidebar-open');
                                
                                if (isSidebarOpen) {
                                    toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                                } else {
                                    toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                                }
                            }
                            
                            // EVENT LISTENERS
                            
                            toggleBtn.addEventListener('click', toggleSidebar);
                            overlay.addEventListener('click', toggleSidebar);
                            
                            menuItems.forEach(item => {
                                item.addEventListener('click', function() {
                                    const dashboardUrl = this.getAttribute('data-src');
                                    
                                    // üîê LOGGING: Obtener qu√© dashboard se est√° accediendo
                                    const dashboardKey = Object.keys(dashboardUrls).find(key => 
                                        dashboardUrls[key] === dashboardUrl
                                    );
                                    
                                    // Registrar acceso al dashboard
                                    if (dashboardKey && currentUser) {
                                        // Enviar mensaje al parent para logging
                                        window.opener?.postMessage({
                                            type: 'log_dashboard_view',
                                            dashboardKey: dashboardKey,
                                            user: currentUser
                                        }, '*');
                                    }
                                    
                                    if (dashboardUrl) {
                                        menuItems.forEach(menuItem => {
                                            menuItem.classList.remove('active');
                                        });
                                        
                                        this.classList.add('active');
                                        iframe.src = dashboardUrl;
                                        
                                        if (isSidebarOpen) {
                                            toggleSidebar();
                                        }
                                    }
                                });
                            });
                            
                            whatsappBtn.addEventListener('click', function() {
                                openWhatsApp();
                            });
                            
                            // INICIALIZACI√ìN
                            
                            // Aplicar bloqueos de seguridad SOLO al sidebar
                            applySecurityBlocks();
                            
                            // Pantalla completa
                            setTimeout(function() {
                                if (document.documentElement.requestFullscreen) {
                                    document.documentElement.requestFullscreen().catch(err => {
                                        console.log('Error al intentar pantalla completa:', err);
                                    });
                                }
                            }, 100);
                        });
                    <\/script>
                </body>
                </html>
            `;
        }
        
        // Funci√≥n para inicializar funcionalidad del dashboard m√≥vil
        function initMobileDashboardFunctionality() {
            const mobileToggleBtn = document.getElementById('mobileToggleBtn');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const mobileIframeContainer = document.getElementById('mobileIframeContainer');
            const mobileIframe = document.getElementById('mobileIframe');
            const mobileMenuItems = document.querySelectorAll('.mobile-menu-item');
            const mobileWhatsappBtn = document.getElementById('mobileWhatsappBtn');
            const mobileExitBtn = document.getElementById('mobileExitBtn');
            
            let isSidebarOpen = false;
            
            // üîí Bloquear clic derecho SOLO en el men√∫ m√≥vil
            mobileSidebar.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            function openWhatsApp() {
                const phoneNumber = '+524421974414';
                const message = 'Hola, necesito ayuda en el Centro de Business Intelligence';
                const url = 'https://wa.me/' + phoneNumber + '?text=' + encodeURIComponent(message);
                window.open(url, '_blank');
            }
            
            function toggleSidebar() {
                isSidebarOpen = !isSidebarOpen;
                mobileSidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                mobileIframeContainer.classList.toggle('sidebar-open');
                
                if (isSidebarOpen) {
                    mobileToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    mobileToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                }
            }
            
            mobileToggleBtn.addEventListener('click', toggleSidebar);
            mobileOverlay.addEventListener('click', toggleSidebar);
            
            mobileMenuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const dashboardUrl = this.getAttribute('data-src');
                    
                    if (dashboardUrl) {
                        // üîê LOGGING: Obtener qu√© dashboard se est√° accediendo
                        const dashboardKey = Object.keys(dashboardUrls).find(key => 
                            dashboardUrls[key] === dashboardUrl
                        );
                        
                        // Registrar acceso al dashboard
                        if (dashboardKey && currentUser) {
                            // Usar la funci√≥n logAccess del scope principal
                            // Como estamos en el mismo contexto, podemos llamarla directamente
                            if (typeof logAccess === 'function') {
                                logAccess('dashboard_view', dashboardKey);
                            }
                        }
                        
                        mobileMenuItems.forEach(menuItem => {
                            menuItem.classList.remove('active');
                        });
                        
                        this.classList.add('active');
                        mobileIframe.src = dashboardUrl;
                        
                        if (isSidebarOpen) {
                            toggleSidebar();
                        }
                    }
                });
            });
            
            mobileWhatsappBtn.addEventListener('click', function() {
                openWhatsApp();
            });
            
            mobileExitBtn.addEventListener('click', function() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    logoutUser();
                }
            });
        }
    </script>
</body>
</html>