name: Handle BI Logs via GitHub Issues

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:

jobs:
  process-bi-log:
    # Solo procesar issues con label 'log'
    if: contains(github.event.issue.labels.*.name, 'log') || github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Extract log data from issue
      id: extract-log
      run: |
        echo "ðŸ” Extrayendo datos del issue..."
        
        # Usamos jq para parsear el issue
        ISSUE_TITLE="${{ github.event.issue.title }}"
        ISSUE_BODY="${{ github.event.issue.body }}"
        
        echo "Issue Title: $ISSUE_TITLE"
        echo "Issue Body preview: ${ISSUE_BODY:0:200}..."
        
        # Crear directorio de logs si no existe
        mkdir -p logs
        
        # Leer logs existentes
        if [ -f "logs/logs.json" ]; then
          LOGS_COUNT=$(jq 'length' logs/logs.json)
          echo "Logs existentes: $LOGS_COUNT"
        else
          echo '[]' > logs/logs.json
          echo "Archivo logs.json creado"
        fi
        
        # Extraer JSON del cuerpo del issue
        if [[ "$ISSUE_BODY" =~ \`\`\`json([^`]+)\`\`\` ]]; then
          JSON_DATA="${BASH_REMATCH[1]}"
          echo "JSON extraÃ­do: ${JSON_DATA:0:100}..."
          
          # Guardar JSON extraÃ­do para uso posterior
          echo "$JSON_DATA" > extracted_log.json
          
          # Extraer campos importantes
          TIMESTAMP=$(echo "$JSON_DATA" | jq -r '.timestamp // .Timestamp // empty')
          USER=$(echo "$JSON_DATA" | jq -r '.user // .User // empty')
          ACTION=$(echo "$JSON_DATA" | jq -r '.action // .Action // empty')
          
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "has_json=true" >> $GITHUB_OUTPUT
          
        else
          echo "No se encontrÃ³ JSON en el issue"
          echo "has_json=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Process and save log
      if: steps.extract-log.outputs.has_json == 'true'
      run: |
        echo "ðŸ“ Procesando log..."
        
        # Leer el JSON extraÃ­do
        JSON_DATA=$(cat extracted_log.json)
        
        # Crear nuevo objeto de log
        NEW_LOG=$(jq -n \
          --arg id "${{ github.event.issue.number }}" \
          --arg timestamp "${{ steps.extract-log.outputs.timestamp }}" \
          --arg user "${{ steps.extract-log.outputs.user }}" \
          --arg action "${{ steps.extract-log.outputs.action }}" \
          --argjson data "$JSON_DATA" \
          '{
            "id": $id,
            "timestamp": $timestamp,
            "user": $user,
            "action": $action,
            "source": "github_issue",
            "issue_url": "https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}",
            "original_data": $data
          }')
        
        echo "Nuevo log:"
        echo "$NEW_LOG" | jq '.'
        
        # Agregar al archivo logs.json
        jq --argjson new "$NEW_LOG" '. += [$new]' logs/logs.json > logs/logs.tmp.json
        
        # Limitar a Ãºltimos 1000 logs
        jq '.[-1000:]' logs/logs.tmp.json > logs/logs.json
        
        # Calcular estadÃ­sticas
        TOTAL_LOGS=$(jq 'length' logs/logs.json)
        TODAY=$(date +%Y-%m-%d)
        TODAY_LOGS=$(jq --arg today "$TODAY" '[.[] | select(.timestamp | startswith($today))] | length' logs/logs.json)
        
        echo "ðŸ“Š EstadÃ­sticas:"
        echo "Total logs: $TOTAL_LOGS"
        echo "Logs hoy: $TODAY_LOGS"
        
    - name: Create stats file
      if: steps.extract-log.outputs.has_json == 'true'
      run: |
        echo "ðŸ“ˆ Generando estadÃ­sticas..."
        
        node -e "
        const fs = require('fs');
        const logs = JSON.parse(fs.readFileSync('logs/logs.json', 'utf8'));
        
        const stats = {
          generated_at: new Date().toISOString(),
          total_logs: logs.length,
          by_action: {},
          by_user: {},
          by_day: {},
          recent_logs: logs.slice(-10).map(log => ({
            id: log.id,
            timestamp: log.timestamp,
            user: log.user,
            action: log.action
          }))
        };
        
        // Contar por acciÃ³n y usuario
        logs.forEach(log => {
          stats.by_action[log.action] = (stats.by_action[log.action] || 0) + 1;
          stats.by_user[log.user] = (stats.by_user[log.user] || 0) + 1;
          
          // Por dÃ­a
          const day = log.timestamp?.substring(0, 10);
          if (day) {
            stats.by_day[day] = (stats.by_day[day] || 0) + 1;
          }
        });
        
        fs.writeFileSync('logs/stats.json', JSON.stringify(stats, null, 2));
        console.log('EstadÃ­sticas guardadas en logs/stats.json');
        "
        
    - name: Commit and push updated logs
      if: steps.extract-log.outputs.has_json == 'true'
      run: |
        echo "ðŸ’¾ Guardando cambios en GitHub..."
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add logs/
        git status
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No hay cambios para commitear"
        else
          git commit -m "ðŸ“Š Actualizar logs: agregar log del issue #${{ github.event.issue.number }}"
          git push
        fi
        
    - name: Close processed issue
      if: steps.extract-log.outputs.has_json == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
            
            console.log(`âœ… Issue #${context.issue.number} cerrado`);
            
          } catch (error) {
            console.error('Error cerrando issue:', error);
          }
          
    - name: Create summary comment
      if: always()
      run: |
        echo "ðŸŽ¯ Proceso de logs completado"
        echo "---"
        echo "Issue: #${{ github.event.issue.number }}"
        echo "Usuario: ${{ steps.extract-log.outputs.user || 'No identificado' }}"
        echo "AcciÃ³n: ${{ steps.extract-log.outputs.action || 'Desconocida' }}"
        echo "Logs totales: $(jq 'length' logs/logs.json 2>/dev/null || echo '0')"
        echo "---"
        echo "ðŸ“Š Ver logs: https://github.com/${{ github.repository }}/blob/main/logs/logs.json"
        echo "ðŸ“ˆ EstadÃ­sticas: https://github.com/${{ github.repository }}/blob/main/logs/stats.json"
