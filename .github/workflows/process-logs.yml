name: Process BI Logs - Hourly Stats

on:
  schedule:
    # Ejecutar cada hora
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  process-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Generate hourly statistics
      run: |
        echo "ðŸ“Š Generando estadÃ­sticas por hora..."
        
        # Crear directorios si no existen
        mkdir -p logs/hourly
        
        if [ -f "logs/logs.json" ]; then
          # Generar archivo por hora
          HOUR=$(date +%Y-%m-%d-%H)
          
          node -e "
          const fs = require('fs');
          const logs = JSON.parse(fs.readFileSync('logs/logs.json', 'utf8') || '[]');
          
          const hourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
          const hourlyLogs = logs.filter(log => 
            log.timestamp && log.timestamp >= hourAgo
          );
          
          const stats = {
            hour: '$HOUR',
            generated_at: new Date().toISOString(),
            logs_in_hour: hourlyLogs.length,
            unique_users: [...new Set(hourlyLogs.map(l => l.user))].length,
            actions_summary: {}
          };
          
          hourlyLogs.forEach(log => {
            stats.actions_summary[log.action] = (stats.actions_summary[log.action] || 0) + 1;
          });
          
          fs.writeFileSync(\`logs/hourly/\${'$HOUR'}.json\`, JSON.stringify(stats, null, 2));
          
          // Actualizar resumen diario
          const today = new Date().toISOString().split('T')[0];
          const todayFile = \`logs/\${today}-summary.json\`;
          let todayStats = {};
          
          if (fs.existsSync(todayFile)) {
            todayStats = JSON.parse(fs.readFileSync(todayFile, 'utf8'));
          }
          
          todayStats['$HOUR'] = stats;
          fs.writeFileSync(todayFile, JSON.stringify(todayStats, null, 2));
          
          console.log(\`âœ… EstadÃ­sticas generadas para hora \${'$HOUR'}:\`, hourlyLogs.length, 'logs');
          "
        else
          echo "No hay logs para procesar"
        fi
        
    - name: Clean old hourly files (keep last 7 days)
      run: |
        echo "ðŸ§¹ Limpiando archivos antiguos..."
        find logs/hourly -name "*.json" -mtime +7 -delete
        echo "âœ… Archivos antiguos eliminados"
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add logs/
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No hay cambios para commitear"
        else
          git commit -m "ðŸ“ˆ Actualizar estadÃ­sticas por hora [skip ci]"
          git push
        fi
