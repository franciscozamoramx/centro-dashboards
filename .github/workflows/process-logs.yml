name: Process BI Logs - Hourly Stats

on:
  schedule:
    # Ejecutar cada hora
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Modo debug'
        required: false
        default: 'false'

jobs:
  process-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necesario para hacer push
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # IMPORTANTE: Especificar el token
        fetch-depth: 0  # Traer todo el historial
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Generate hourly statistics
      run: |
        echo "ğŸ“Š Generando estadÃ­sticas por hora..."
        
        # Crear directorios si no existen
        mkdir -p logs/hourly
        
        if [ -f "logs/logs.json" ]; then
          # Generar archivo por hora
          HOUR=$(date -u +%Y-%m-%d-%H)
          
          node -e "
          const fs = require('fs');
          
          try {
            // Leer logs actuales
            const logsContent = fs.readFileSync('logs/logs.json', 'utf8');
            const logs = logsContent ? JSON.parse(logsContent) : [];
            
            console.log(\`Total de logs encontrados: \${logs.length}\`);
            
            // Calcular logs de la Ãºltima hora
            const hourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
            const hourlyLogs = logs.filter(log => 
              log && log.timestamp && log.timestamp >= hourAgo
            );
            
            console.log(\`Logs en la Ãºltima hora: \${hourlyLogs.length}\`);
            
            // Generar estadÃ­sticas
            const stats = {
              hour: '$HOUR',
              generated_at: new Date().toISOString(),
              total_logs_in_hour: hourlyLogs.length,
              unique_users: [...new Set(hourlyLogs.map(l => l.user).filter(Boolean))].length,
              actions_summary: {},
              device_summary: {}
            };
            
            // Contar por acciÃ³n y dispositivo
            hourlyLogs.forEach(log => {
              if (log.action) {
                stats.actions_summary[log.action] = (stats.actions_summary[log.action] || 0) + 1;
              }
              if (log.deviceType) {
                stats.device_summary[log.deviceType] = (stats.device_summary[log.deviceType] || 0) + 1;
              }
            });
            
            // Guardar estadÃ­sticas por hora
            const hourlyFile = \`logs/hourly/\${'$HOUR'}.json\`;
            fs.writeFileSync(hourlyFile, JSON.stringify(stats, null, 2));
            console.log(\`âœ… Archivo guardado: \${hourlyFile}\`);
            
            // Actualizar resumen diario
            const today = new Date().toISOString().split('T')[0];
            const todayFile = \`logs/\${today}-summary.json\`;
            let todayStats = {};
            
            if (fs.existsSync(todayFile)) {
              try {
                todayStats = JSON.parse(fs.readFileSync(todayFile, 'utf8'));
              } catch (e) {
                console.log('âš ï¸ Error leyendo archivo diario, creando nuevo:', e.message);
              }
            }
            
            todayStats['$HOUR'] = stats;
            fs.writeFileSync(todayFile, JSON.stringify(todayStats, null, 2));
            console.log(\`âœ… Resumen diario actualizado: \${todayFile}\`);
            
          } catch (error) {
            console.error('âŒ Error procesando logs:', error.message);
            process.exit(1);
          }
          "
        else
          echo "âš ï¸ No hay logs.json para procesar"
          # Crear archivo vacÃ­o de estadÃ­sticas para evitar error
          HOUR=$(date -u +%Y-%m-%d-%H)
          echo "{\"hour\":\"$HOUR\",\"generated_at\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"total_logs_in_hour\":0,\"unique_users\":0,\"actions_summary\":{},\"device_summary\":{}}" > logs/hourly/$HOUR.json
        fi
        
    - name: Clean old hourly files (keep last 7 days)
      run: |
        echo "ğŸ§¹ Limpiando archivos antiguos..."
        # Buscar y eliminar archivos de mÃ¡s de 7 dÃ­as
        find logs/hourly -name "*.json" -mtime +7 -delete 2>/dev/null || true
        echo "âœ… Limpieza completada"
        
    - name: Commit and push if changed
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # Verificar cambios
        git status
        
        # Agregar todos los cambios en logs/
        git add logs/
        
        # Verificar si hay cambios para commitear
        if ! git diff --cached --quiet; then
          echo "ğŸ“ Hay cambios para commitear"
          git commit -m "ğŸ“ˆ Actualizar estadÃ­sticas por hora [$(date -u +%Y-%m-%d-%H)]"
          
          # Intentar push con reintentos
          for i in {1..3}; do
            echo "ğŸ”„ Intento $i de push..."
            if git push; then
              echo "âœ… Push exitoso"
              break
            else
              echo "âš ï¸ FallÃ³ push, reintentando..."
              sleep 5
              git pull --rebase
            fi
          done
        else
          echo "âœ… No hay cambios para commitear"
        fi
